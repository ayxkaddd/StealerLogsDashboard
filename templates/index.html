<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap");
        * {
            font-family: "JetBrains Mono", monospace;
        }

        /* Button styles */
        .btn-glow:hover {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        /* Table styles */
        .domain-cell {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .table-cell-content {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        /* Drop zone styles */
        .drop-zone {
            border: 2px dashed #666;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #fff;
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: #111111;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 12px;
            width: 95%;
            max-width: 1400px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            cursor: pointer;
        }

        /* Sort button styles */
        .sort-btn {
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sort-btn i {
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .sort-btn:hover i {
            opacity: 1;
        }

        .sort-btn.active i {
            opacity: 1;
            color: white;
        }
        .search-container {
            display: flex;
            gap: 1px;
            background: #111111;
            border-radius: 0.75rem;
        }

        .search-type-dropdown {
            position: relative;
            min-width: 140px;
            background: black;
            border-radius: 0.75rem 0 0 0.75rem;
        }

        .search-type-btn {
            width: 100%;
            height: 100%;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #888;
            transition: all 0.2s;
            background: black;
            border: none;
            font-size: 1rem;
            border-radius: 0.75rem 0 0 0.75rem;
        }

        .search-type-btn:hover {
            color: white;
        }

        .search-type-menu {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            background-color: black;
            border: 1px solid #333;
            border-radius: 0.75rem;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .search-type-menu.show {
            display: block;
        }

        .search-type-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-type-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .search-type-item i {
            width: 1.25rem;
        }

        .query-input-container {
            flex: 1;
            background: black;
            border-radius: 0 0.75rem 0.75rem 0;
            overflow: hidden;

        }
    </style>
</head>
<body class="h-full bg-black text-white">
    <!-- Main Container -->
    <div class="flex h-full">
        <div class="flex-1 p-8 bg-[#111111]">
            <div class="max-w-[1400px] mx-auto">
                <!-- Search Section -->
                <div class="mb-8">
                    <div id="dropZone" class="relative drop-zone rounded-xl mb-4">
                        <div class="search-container">
                            <!-- Search Type Dropdown -->
                            <div class="search-type-dropdown">
                                <button id="searchTypeBtn" class="search-type-btn">
                                    <i class="fas fa-search"></i>
                                    <span id="currentSearchType">ALL</span>
                                    <i class="fas fa-chevron-down ml-1"></i>
                                </button>
                                <div id="searchTypeMenu" class="search-type-menu">
                                    <div class="search-type-item" data-value="all">
                                        <i class="fas fa-search"></i>
                                        <span>All Fields</span>
                                    </div>
                                    <div class="search-type-item" data-value="domain">
                                        <i class="fas fa-globe"></i>
                                        <span>Domain</span>
                                    </div>
                                    <div class="search-type-item" data-value="email">
                                        <i class="fas fa-envelope"></i>
                                        <span>Email</span>
                                    </div>
                                    <div class="search-type-item" data-value="password">
                                        <i class="fas fa-key"></i>
                                        <span>Password</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Query Input -->
                            <div class="query-input-container">
                                <input id="queryInput" type="text"
                                       placeholder="enter your query or drag & drop JSON/CSV file here..."
                                       class="w-full h-full bg-transparent border-0 px-6 py-3 text-lg text-white placeholder-gray-500 focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3 mt-4">
                        <button id="queryBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-search mr-2"></i>search
                        </button>
                        <button id="exportCsvBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-file-csv mr-2"></i>csv
                        </button>
                        <button id="exportJsonBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-file-code mr-2"></i>json
                        </button>
                        <button id="exportUniquePasswordsBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-key mr-2"></i>passwords
                        </button>
                        <button id="exportUniqueEmailsBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-envelope mr-2"></i>emails
                        </button>
                        <button id="showFileStatsBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-file-lines mr-2"></i>files
                        </button>
                        <button id="resetBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                            <i class="fas fa-times mr-2"></i>clear
                        </button>
                    </div>
                </div>

                <!-- Loader -->
                <div id="loader" class="hidden flex justify-center items-center mb-6">
                    <i class="fas fa-spinner fa-spin fa-2x text-gray-500"></i>
                </div>

                <!-- Main Table -->
                <div class="overflow-x-auto max-h-[calc(100vh-250px)] overflow-y-auto border border-gray-800 rounded-xl">
                    <table class="w-full table-fixed">
                        <thead class="bg-black sticky top-0">
                            <tr>
                                <th class="w-1/4 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">Domain</th>
                                <th class="w-1/4 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">URI</th>
                                <th class="w-1/4 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">Email/Username</th>
                                <th class="w-1/4 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">Password</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- File Stats Modal -->
    <div id="fileStatsModal" class="modal">
        <div class="modal-content">
            <span class="close text-gray-500 text-2xl hover:text-white">&times;</span>
            <div class="mb-6">
                <h2 class="text-2xl mb-4">File Statistics</h2>
                <div class="flex gap-3 mb-4">
                    <button id="refreshStatsBtn" class="action-btn px-4 py-2 bg-black border border-gray-800 rounded-xl text-base hover:bg-gray-900 transition-all btn-glow">
                        <i class="fas fa-sync-alt mr-2"></i>refresh
                    </button>
                    <div class="px-4 py-2 bg-black border border-gray-800 rounded-xl text-base">
                        <span class="text-gray-400 mr-2">Total Lines:</span>
                        <span id="totalLinesCount">0</span>
                    </div>
                </div>
            </div>

            <div id="fileStatsLoader" class="hidden flex justify-center items-center mb-6">
                <i class="fas fa-spinner fa-spin fa-2x text-gray-500"></i>
            </div>

            <div class="overflow-x-auto border border-gray-800 rounded-xl">
                <table class="w-full">
                    <thead class="bg-black sticky top-0">
                        <tr>
                            <th class="w-1/3 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">Filename</th>
                            <th class="w-1/3 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">
                                <div class="sort-btn" data-sort="timestamp">
                                    Created At
                                    <i class="fas fa-sort"></i>
                                </div>
                            </th>
                            <th class="w-1/3 py-3 px-6 text-left text-gray-400 font-normal text-lg border-b border-gray-800">
                                <div class="sort-btn" data-sort="lines">
                                    Lines Count
                                    <i class="fas fa-sort"></i>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="fileStatsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Global variables
        let logData = [];
        let txtFileContent = null;
        let currentFileStats = { files: [] };
        let currentSort = { field: null, direction: 'asc' };
        let currentSearchType = 'all';

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const queryInput = document.getElementById('queryInput');
        const modal = document.getElementById('fileStatsModal');
        const fileStatsLoader = document.getElementById('fileStatsLoader');
        const totalLinesCount = document.getElementById('totalLinesCount');
        const searchTypeBtn = document.getElementById('searchTypeBtn');
        const searchTypeMenu = document.getElementById('searchTypeMenu');
        const currentSearchTypeText = document.getElementById('currentSearchType');

        // Button click handlers
        document.getElementById('queryBtn').onclick = handleSearch;
        document.getElementById('exportCsvBtn').onclick = () => exportToCSV(logData);
        document.getElementById('exportJsonBtn').onclick = () => exportToJSON(logData);
        document.getElementById('exportUniquePasswordsBtn').onclick = () => exportUniquePasswords(logData);
        document.getElementById('exportUniqueEmailsBtn').onclick = () => exportUniqueEmails(logData);
        document.getElementById('showFileStatsBtn').onclick = showFileStats;
        document.getElementById('refreshStatsBtn').onclick = fetchFileStats;
        document.getElementById('resetBtn').onclick = resetApplication;
        document.querySelector('.close').onclick = closeModal;

        // Modal handlers
        window.onclick = (event) => {
            if (event.target === modal) closeModal();
        };

        // Sort handlers
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => sortFiles(btn.dataset.sort));
        });

        searchTypeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            searchTypeMenu.classList.toggle('show');
        });

        // Handle search type selection
        document.querySelectorAll('.search-type-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const value = item.dataset.value;
                currentSearchType = value;
                currentSearchTypeText.textContent = value.toUpperCase();
                searchTypeMenu.classList.remove('show');
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchTypeBtn.contains(e.target) && !searchTypeMenu.contains(e.target)) {
                searchTypeMenu.classList.remove('show');
            }
        });

        dropZone.addEventListener('click', (e) => {
            if (searchTypeBtn.contains(e.target) || searchTypeMenu.contains(e.target)) {
                e.stopPropagation();
            }
        });

        // Drag and drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        // File handling functions
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const file = dt.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    if (file.name.endsWith('.json')) {
                        logData = JSON.parse(event.target.result);
                        populateTable(logData);
                    } else if (file.name.endsWith('.csv')) {
                        logData = parseCSV(event.target.result);
                        populateTable(logData);
                    } else if (file.name.endsWith('.txt')) {
                        txtFileContent = event.target.result;
                        queryInput.value = `Loaded file: ${file.name}`;
                        queryInput.disabled = true;
                    }
                } catch (error) {
                    console.error('Error parsing file:', error);
                }
            };

            if (file.name.match(/\.(json|csv|txt)$/)) {
                reader.readAsText(file);
            }
        }

        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',').map(header =>
                header.trim().toLowerCase().replace(/["']/g, '')
            );

            return lines.slice(1)
                .map(line => {
                    if (!line.trim()) return null;
                    const values = line.split(',').map(value =>
                        value.trim().replace(/["']/g, '')
                    );
                    const obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] || '';
                    });
                    return obj;
                })
                .filter(item => item !== null);
        }

        // UI update functions
        function populateTable(data) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';

            data.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-800 hover:bg-gray-900';

                const redactedDomain = truncateText(log.domain, 30);
                const redactedUri = truncateText(log.uri, 30);
                const redactedEmail = truncateText(log.email, 30);
                const redactedPassword = truncateText(log.password, 30);

                row.innerHTML = `
                    <td class="py-3 px-6">
                        <div class="domain-cell">
                            <img src="https://www.google.com/s2/favicons?domain=${encodeURIComponent(log.domain)}&sz=48"
                                 alt="${redactedDomain} favicon" class="w-6 h-6 mr-3">
                            <div class="table-cell-content">${redactedDomain}</div>
                        </div>
                    </td>
                    <td class="py-3 px-6">
                        <div class="table-cell-content text-gray-300">${redactedUri || "-"}</div>
                    </td>
                    <td class="py-3 px-6">
                        <div class="table-cell-content text-gray-300">${redactedEmail}</div>
                    </td>
                    <td class="py-3 px-6">
                        <div class="table-cell-content text-gray-300">${redactedPassword}</div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Utility functions
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            dropZone.classList.add('drag-over');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-over');
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function showFileStats() {
            modal.style.display = 'block';
            fetchFileStats();
        }

        // File statistics functions
        async function fetchFileStats() {
            fileStatsLoader.classList.remove('hidden');
            try {
                const response = await fetch('/api/logs/files/');
                currentFileStats = await response.json();
                updateFileStatsTable();
            } catch (error) {
                console.error('Error fetching file stats:', error);
            } finally {
                fileStatsLoader.classList.add('hidden');
            }
        }

        function sortFiles(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }

            // Update sort icons and active states
            document.querySelectorAll('.sort-btn i').forEach(icon => {
                icon.className = 'fas fa-sort';
            });
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const currentButton = document.querySelector(`.sort-btn[data-sort="${field}"]`);
            currentButton.classList.add('active');
            currentButton.querySelector('i').className =
                `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'}`;

            updateFileStatsTable();
        }

        function updateFileStatsTable() {
            const tbody = document.getElementById('fileStatsTableBody');
            const files = [...currentFileStats.files];

            if (currentSort.field) {
                files.sort((a, b) => {
                    let comparison = 0;
                    if (currentSort.field === 'timestamp') {
                        comparison = new Date(a.creation_time) - new Date(b.creation_time);
                    } else if (currentSort.field === 'lines') {
                        comparison = a.line_count - b.line_count;
                    }
                    return currentSort.direction === 'asc' ? comparison : -comparison;
                });
            }

            tbody.innerHTML = '';
            let total = 0;

            files.forEach(file => {
                total += file.line_count;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-800 hover:bg-gray-900';
                row.innerHTML = `
                    <td class="py-3 px-6">
                        <div class="flex items-center">
                            <i class="fas fa-file-text mr-3 text-gray-500"></i>
                            <div class="text-white">${file.filename}</div>
                        </div>
                    </td>
                    <td class="py-3 px-6 text-gray-300">
                        ${new Date(file.creation_time).toLocaleString()}
                    </td>
                    <td class="py-3 px-6 text-gray-300">
                        ${file.line_count.toLocaleString()}
                    </td>
                `;
                tbody.appendChild(row);
            });

            totalLinesCount.textContent = total.toLocaleString();
        }

        // Search and reset functions
        async function handleSearch() {
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            try {
                let response;
                if (txtFileContent) {
                    const processedContent = txtFileContent.split('\n')
                        .filter(line => line.trim())
                        .join('|');
                    response = await fetch('/api/logs/search/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: processedContent,
                            field: currentSearchType,
                            bulk: true
                        })
                    });
                } else {
                    response = await fetch('/api/logs/search/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: queryInput.value,
                            field: currentSearchType,
                            bulk: false
                        })
                    });
                }

                logData = await response.json();
                populateTable(logData);
            } catch (error) {
                console.error('Error fetching data:', error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function resetApplication() {
            txtFileContent = null;
            queryInput.value = '';
            queryInput.disabled = false;
            logData = [];
            document.getElementById('logsTableBody').innerHTML = '';
        }

        // Export functions
        function exportToCSV(data) {
            const headers = ['Domain', 'URI', 'Email', 'Password'];
            const csvRows = [
                headers.join(','),
                ...data.map(row =>
                    headers.map(header => {
                        const value = row[header.toLowerCase()] || '';
                        const escaped = value.toString().replace(/"/g, '\\"');
                        return `"${escaped}"`;
                    }).join(',')
                )
            ];

            downloadFile(csvRows.join('\n'), 'logs.csv', 'text/csv');
        }

        function exportToJSON(data) {
            const jsonString = JSON.stringify(data, null, 2);
            downloadFile(jsonString, 'logs.json', 'application/json');
        }

        function exportUniquePasswords(data) {
            const uniquePasswords = [...new Set(data.map(item => item.password))];
            const jsonString = JSON.stringify(uniquePasswords, null, 2);
            downloadFile(jsonString, 'unique_passwords.json', 'application/json');
        }

        function exportUniqueEmails(data) {
            const uniqueEmails = [...new Set(data.map(item => item.email))];
            const jsonString = JSON.stringify(uniqueEmails, null, 2);
            downloadFile(jsonString, 'unique_emails.json', 'application/json');
        }

        function downloadFile(content, fileName, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>